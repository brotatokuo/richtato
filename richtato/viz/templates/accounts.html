{% extends "layout.html" %}
{% load static %}
{% load humanize %}
{% block body %}

<div class="page-container">
    <div class="page-title">
        <h1>Accounts and Networth</h1>
        <h2>Networth: ${{ networth|floatformat:2|intcomma }}</h2>
    </div>

    <div class="bar-chart">
        <canvas id="pieChart"></canvas>
    </div>

    <br>
    <br>

    <div class="bar-chart">
        <canvas id="accountsChart"></canvas>
    </div>

    <div class="page-item">
        <ul class="stock-list">
            <table class="detailed-table, styled-table">
                <thead>
                    <tr>
                        <th>Account Name</th>
                        <th>Account Type</th>
                        <th>Date</th>
                        <th>Balance</th>
                    </tr>
                </thead>
                <tbody>
                {% for item in accounts_data %}
                    <tr>
                    {% for balance, date in item.history %}
                        <td>{{ item.account.name }}</td>
                        <td>{{ item.account.type|capfirst }}</td>
                        <td>{{ date|date:"Y-m-d" }}</td>
                        <td>${{ balance }}</td>
                    </tr>
                    {% endfor %}
                {% endfor %}
                </tbody>
            </table>
        </ul>
    </div>

    <div class="login-form">
        <h2 class="subtitle">Update Account Balance</h2>
        <form method="post" action="{% url 'update_accounts' %}">
            {% csrf_token %}

            <!-- Account field -->
            <div class="form-group">
                <label for="account">Account:</label>
                <select class="form-control" id="account-id" name="account-id" required>
                    {% for item in accounts_data %}
                        <option value="{{ item.account.id }}">{{ item.account.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <br>

            <br>

            <!-- Amount field -->
            <div class="form-group">
                <label for="amount">Amount:</label>
                <input class="form-control" type="number" step="0.01" id="balance-input" name="balance-input" required>
            </div>

            <br>
            
            
            <!-- Date field -->
            <div class="form-group">
                <label for="date">Date:</label>
                <input class="form-control" type="date" id="balance-date" name="balance-date" required>
            </div>

            <br>

            <button type="submit" class="btn-secondary">Update</button>
        </form>
    </div>
</div>

<script src="{% static 'richtato/accounts_script.js' %}"></script>
<script>
    // Run the fetchChartData function from script.js
    const dataUrl = "{% url 'plot_accounts_data' %}";
    const piedataUrl = "{% url 'plot_accounts_data_pie' %}";
    fetch("{% url 'get_accounts_data_json' %}")
        .then(response => response.json())
        .then(tableData => {
            console.log("fetch data");
            console.log(tableData);
            
            // Call the chart function after data is successfully fetched
            stackedFetchChartData(dataUrl, "accountsChart", tableData);
            pieChartData(piedataUrl, "pieChart", tableData);
        })
        .catch(error => console.error('Error:', error));
    
</script>
{% endblock %}
