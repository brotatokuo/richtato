{% extends 'base.html' %}
{% load static %}

{% block title %}{{ account.name }} - Transaction History{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
  <div class="page-title">
    <h1><i class="fas fa-chart-line"></i> {{ account.name }}</h1>
    <p>Balance over time</p>
  </div>
  <div class="page-actions">
    <button onclick="window.history.back()" class="btn secondary">
      <i class="fas fa-arrow-left"></i> Back
    </button>
  </div>
</div>

<div class="analytics-container">
  <div class="analytics-card large">
    <div class="card-header">
      <h2>Account Balance Over Time</h2>
      <div class="chart-controls">
        <select id="timeRange" class="form-control modern-dropdown">
          <option value="30">Last 30 days</option>
          <option value="90">Last 3 months</option>
          <option value="180">Last 6 months</option>
          <option value="365" selected>Last year</option>
          <option value="all">All time</option>
        </select>
      </div>
    </div>
    <div class="card-body">
      <div class="chart-container" style="position: relative; height: 400px;">
        <canvas id="transactionChart"></canvas>
      </div>
    </div>
  </div>

  <div class="analytics-card">
    <div class="card-header">
      <h2>Account Summary</h2>
    </div>
    <div class="card-body">
      <div class="summary-stats modern-stats">
        <div class="stat-item primary">
          <div class="stat-icon">
            <i class="fas fa-wallet"></i>
          </div>
          <div class="stat-content">
            <div class="stat-label">Current Balance</div>
            <div class="stat-value" id="currentBalance">${{ account.latest_balance|floatformat:2 }}</div>
          </div>
        </div>
        <div class="stat-item growth">
          <div class="stat-icon">
            <div id="growthIcon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M7 14L12 9L17 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </div>
          <div class="stat-content">
            <div class="stat-label">Growth (1 Year)</div>
            <div class="stat-value" id="growthValue">Loading...</div>
            <div class="stat-subvalue" id="growthPercentage">Loading...</div>
          </div>
        </div>
        <div class="stat-item info">
          <div class="stat-icon">
            <i class="fas fa-building"></i>
          </div>
          <div class="stat-content">
            <div class="stat-label">{{ account.type|title }}</div>
            <div class="stat-value">{{ account.asset_entity_name|title }}</div>
          </div>
        </div>
        <div class="stat-item info">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <div class="stat-label">Last Updated</div>
            <div class="stat-value">{{ account.latest_balance_date|date:"M d, Y" }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const accountId = {{ account_id }};
  let chart = null;

  function initChart() {
    const ctx = document.getElementById('transactionChart').getContext('2d');

    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Account Balance',
          data: [],
          borderColor: '#98cc2c',
          backgroundColor: 'rgba(152, 204, 44, 0.2)',
          tension: 0.1,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Account Balance Over Time'
          },
          legend: {
            display: false
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            ticks: {
              callback: function(value, index, values) {
                return '$' + value.toLocaleString();
              }
            }
          },
          x: {
            type: 'time',
            time: {
              unit: 'day',
              displayFormats: {
                day: 'MMM dd',
                month: 'MMM yyyy'
              }
            }
          }
        },
        interaction: {
          intersect: false,
          mode: 'index'
        },
        plugins: {
          tooltip: {
            callbacks: {
              label: function(context) {
                return 'Balance: $' + context.parsed.y.toLocaleString();
              }
            }
          }
        }
      }
    });
  }

  function loadTransactionData(days = 30) {
    let url = `/api/accounts/${accountId}/transactions/`;
    if (days !== 'all') {
      url += `?days=${days}`;
    }

    fetch(url)
      .then(response => response.json())
      .then(data => {
        const transactions = data.rows || [];

        if (transactions.length === 0) {
          chart.data.labels = [];
          chart.data.datasets[0].data = [];
          chart.update();
          return;
        }

        // Sort transactions by date (oldest first)
        transactions.sort((a, b) => new Date(a.date) - new Date(b.date));

        const chartData = [];
        let runningBalance = 0;

        transactions.forEach(transaction => {
          // Convert currency string to number
          const amount = parseFloat(transaction.amount.replace(/[$,]/g, ''));
          runningBalance = amount; // AccountTransaction stores the balance at that point

          chartData.push({
            x: transaction.date,
            y: runningBalance
          });
        });

        chart.data.labels = transactions.map(t => t.date);
        chart.data.datasets[0].data = chartData;
        chart.update();

        // Calculate and display growth statistics
        updateGrowthStats(chartData);
      })
      .catch(error => {
        console.error('Error loading transaction data:', error);
      });
  }

  // Initialize chart
  initChart();

  // Set default dropdown value to 365 days (1 year)
  document.getElementById('timeRange').value = '365';

  // Load initial data with 1 year default
  loadTransactionData(365);

  // Handle time range changes
  document.getElementById('timeRange').addEventListener('change', function(e) {
    const days = e.target.value;
    loadTransactionData(days);
  });

  function updateGrowthStats(chartData) {
    if (chartData.length < 2) {
      document.getElementById('growthValue').textContent = 'N/A';
      document.getElementById('growthPercentage').textContent = 'Insufficient data';
      return;
    }

    const firstBalance = chartData[0].y;
    const lastBalance = chartData[chartData.length - 1].y;
    const growthAmount = lastBalance - firstBalance;

    // Handle zero starting value - show NaN for percentage
    let growthPercentage;
    let formattedPercentage;
    if (firstBalance === 0) {
      growthPercentage = NaN;
      formattedPercentage = 'N/A';
    } else {
      growthPercentage = (growthAmount / Math.abs(firstBalance)) * 100;
      formattedPercentage = growthAmount >= 0 ? `+${growthPercentage.toFixed(1)}%` : `${growthPercentage.toFixed(1)}%`;
    }

    const growthIcon = document.getElementById('growthIcon');
    const growthValueEl = document.getElementById('growthValue');
    const growthPercentageEl = document.getElementById('growthPercentage');

    // Format the growth amount
    const formattedGrowth = growthAmount >= 0 ? `+$${Math.abs(growthAmount).toLocaleString()}` : `-$${Math.abs(growthAmount).toLocaleString()}`;

    growthValueEl.textContent = formattedGrowth;
    growthPercentageEl.textContent = formattedPercentage;

    // Update styling and arrow direction based on growth
    const statItem = growthValueEl.closest('.stat-item');

    if (firstBalance === 0 || growthAmount === 0) {
      // Neutral styling for zero starting value or no change
      statItem.classList.remove('positive-growth', 'negative-growth');
      statItem.classList.add('growth');
      growthIcon.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M5 12H19" stroke="#6b7280" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
    } else if (growthAmount > 0) {
      statItem.classList.remove('negative-growth', 'growth');
      statItem.classList.add('positive-growth');
      growthIcon.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M7 14L12 9L17 14" stroke="#10b981" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
    } else {
      statItem.classList.remove('positive-growth', 'growth');
      statItem.classList.add('negative-growth');
      growthIcon.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 10L12 15L7 10" stroke="#ef4444" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      `;
    }
  }
});
</script>
{% endblock %}
